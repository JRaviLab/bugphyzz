---
title: "Curation Checks"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(bugphyzz)
library(dplyr)
library(purrr)
```

Import all of the datasets through the functions provided by the bugphyzz
package.

```{r, message=FALSE}
phys <- physiologies()

## the full name of the 'fatty acid composition' must be used here
phys[["fatty acid composition"]] <- fattyAcidComposition()
```

# Check required columns

The function `.checkRequiredColumnList()` performs two checks:  
1. That all of the required columns are present.  
2. That the required columns are in the right order.

```{r, message=FALSE}
err1 <- bugphyzz:::.checkRequiredColumnsList(phys)
```

The resutls have four columns:  
1. 'dataset' contains the name of each dataset.  
2. 'error_type' contains the type of error (missing column or misplaced
column).  
3. 'columns' the name of the columns that must be corrected.  
4. 'link' the link to the dataset.

```{r}
glimpse(err1)
```

Visualization of the errors:

```{r}
err1 %>% 
    knitr::kable()
```

# Check the syntax of the values

The function `.checkColumnValuesList` performs two checks:  
1. That a column is cataloged in the template file.  
2. That all of the values in a column are valid according to the template  
file.

```{r, message=FALSE}
err2 <- bugphyzz:::.checkColumnValuesList(phys)
```

The output contains seven columns:  
1. 'dataset' contains the name of the dataset.  
2. 'error_type' contains the type of the error. 'uncatalogued' if the column has
not been added to the template.tsv file, and 'Invalid' if the values don't
match the values in the template.tsv file.  
3. 'col' contains the name of the column with invalid values (or uncatalogued).  
4. 'n_rows' the number of rows with invalid values. NA if the column is
uncatalogued.  
5. 'invalid_values' a list with the invalid values. NA if the column is
uncatalogued.  
6. 'invalid_pos' a list with the positions with invalid values. NA if the
column is uncatalogued.  
7. 'link' which contains the link to the dataset indicated in the first column.  

```{r}
glimpse(err2)
```

Invalid values and positions can be printed by subsetting the table:

```{r}
## Print the invalid values in the Attribute_value column of the
## acetate producing dataset
err2 %>% 
    filter(dataset == "acetate producing", col == "Attribute_value") %>% 
    pull(invalid_values)
```

```{r}
## Print the position with invalid values in the Attribute_value column of
## the acetate producing dataset
err2 %>% 
    filter(dataset == "acetate producing", col == "Attribute_value") %>% 
    pull(invalid_pos)
```

Visualization of the errors:

```{r}
## invalid_values and invalid_pos are not printed here because they
## are too many
err2 %>% 
    select(-invalid_values, -invalid_pos) %>% # to many values
    knitr::kable()
```

# Check valid NCBI IDs

This function is not included in the package because it would add taxizedb
as a dependency

```{r}
check_valid_NCBI_IDs <- function(dat) {

  ncbi_ids <- dat[["NCBI_ID"]]
  taxonomies <- taxizedb::classification(ncbi_ids, db = "ncbi")
  invalid_positions_lgl <- !is.na(ncbi_ids) & is.na(taxonomies)
  names(invalid_positions_lgl) <- NULL
  invalid_positions <- which(invalid_positions_lgl)

  if (!length(invalid_positions)) {
    message("All NCBI IDs are valid.")
    return(NULL)
  }

  invalid_values <- ncbi_ids[invalid_positions]

  list(invalid_positions = invalid_positions, invalid_values = invalid_values)

  bugphyzz:::.stop_custom("invalid_ncbi_ids", message = "Invalid NCBI IDs.",
    invalid_positions = invalid_positions, invalid_values = invalid_values)
}
```


```{r}
err_list <- lapply(phys, function(x) {
    tryCatch(
      invalid_ncbi_ids = function(e) e,
      check_valid_NCBI_IDs(x)
    )
  }) %>%
    discard(is.null)



```



```{r}
map(err_list, ~{
  tibble::tibble(
    error_type = class(.x)[1],
    invalid_pos = .x$invalid_positions,
    invalid_val = as.character(.x$invalid_values)
  )
}) %>% bind_rows(.id = "dataset") %>% 
  group_by(across(c(-invalid_val, -invalid_pos))) %>% 
  summarise(across(starts_with("invalid"), ~list(.x))) %>% 
  knitr::kable()
```






