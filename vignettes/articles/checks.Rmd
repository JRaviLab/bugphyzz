---
title: "Curation Checks"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE}
library(bugphyzz)
library(dplyr)
library(purrr)
```

Import all of the datasets through the functions provided by the bugphyzz
package.

```{r, message=FALSE}
phys <- physiologies()

## the full name of the 'fatty acid composition' must be used here
phys[["fatty acid composition"]] <- fattyAcidComposition()
```

# Check required columns

The function `.checkRequiredColumnList()` performs two checks:  
1. That all of the required columns are present.  
2. That the required columns are in the right order.

```{r, message=FALSE}
err1 <- bugphyzz:::.checkRequiredColumnsList(phys)
```

The resutls have four columns:  
1. 'dataset' contains the name of each dataset.  
2. 'error_type' contains the type of error (missing column or misplaced
column).  
3. 'columns' the name of the columns that must be corrected.  
4. 'link' the link to the dataset.

Visualization of the errors:

```{r}
if (!is.null(err1)) {
  DT::datatable(err1)
}
```

# Check the syntax of the values

The function `.checkColumnValuesList` performs two checks:  
1. That a column is cataloged in the template file.  
2. That all of the values in a column are valid according to the template  
file.

```{r, message=FALSE}
err2 <- bugphyzz:::.checkColumnValuesList(phys)
```

The output contains seven columns:  
1. 'dataset' contains the name of the dataset.  
2. 'error_type' contains the type of the error. 'uncatalogued' if the column has
not been added to the template.tsv file, and 'Invalid' if the values don't
match the values in the template.tsv file.  
3. 'col' contains the name of the column with invalid values (or uncatalogued).  
4. 'n_rows' the number of rows with invalid values. NA if the column is
uncatalogued.  
5. 'invalid_values' a list with the invalid values. NA if the column is
uncatalogued.  
6. 'invalid_pos' a list with the positions with invalid values. NA if the
column is uncatalogued.  
7. 'link' which contains the link to the dataset indicated in the first column.  

```{r}
glimpse(err2)
```

Invalid values and positions can be printed by subsetting the table:

```{r}
## Print the invalid values in the Attribute_value column of the
## acetate producing dataset
err2 %>% 
    filter(dataset == "acetate producing", col == "Attribute_value") %>% 
    pull(invalid_values)
```

```{r}
## Print the position with invalid values in the Attribute_value column of
## the acetate producing dataset
err2 %>% 
    filter(dataset == "acetate producing", col == "Attribute_value") %>% 
    pull(invalid_pos)
```

Visualization of the errors:

```{r}
## invalid_values and invalid_pos are not printed here because they
## are too many
err2 %>% 
    select(-invalid_values, -invalid_pos) %>% # to many values
    knitr::kable()
```


# Check valid NCBI IDs

NCBI IDs are compared against the latest version of the NCBI ID database
available through `taxizedb`.

If an NCBI ID is **outdated** (some IDs are no longer in use or are merged into
another one), then a more recent NCBI ID and taxon name are suggested based on
the result of `taxize::classification`. You should see "outdated" in the 
comment column (below).

If no NCBI ID is suggested, it's likely because the taxid doesn't exist.
You should see "not found" in the comment column (below).

Note: taxize and taxizedb are not based on the same annotations. Both former
and updated annotations can be accessed through taxize. However, this can take
a long time since the client must make requests to the NCBI API. Having
an NCBI API key can help (it's free once you created your NCBI account). On the
other hand, working with the taxizedb functions is much faster. This is because
the NCBI database is downloaded first to the user's machine. Only the most
recent version of the database is downloaded, that's why only current 
annotations are show. 
Roughly, taxize behaves like https://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi
while taxizedb behaves like https://www.ncbi.nlm.nih.gov/taxonomy/.


```{r, message=FALSE, warning=FALSE}
id_err <- lapply(phys, check_valid_ncbi_ids) %>% 
  purrr::discard(is.null) %>%
  bind_rows(.id = 'dataset')

links_file <- system.file('extdata/source_links.tsv', package = 'bugphyzz')
links <- readr::read_tsv(links_file, show_col_types = FALSE)

id_err_tbl <- dplyr::left_join(id_err, links, by = c('dataset' = 'Attribute'))
dim(id_err_tbl)
```

```{r, message=FALSE, warning=FALSE}
DT::datatable(id_err_tbl)
```


